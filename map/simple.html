<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>D</title>

    <!-- Bootstrap core CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" integrity="sha512-dTfge/zgoMYpP7QbHy4gWMEGsbsdZeCXz7irItjcC3sPUFtf0kuFbDz/ixG7ArTxmDjLXDmezHubeNikyKGVyQ==" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="css/dashboard.css">
</head>

<body>
    <svg id="svgCanvas" version="1.1" baseProfile="full" xmlns="http://www.w3.org/2000/svg">
        <g id="viewport">
            <circle id="moveMe" cx="800" cy="282" r="80" fill="green"  />
        </g>
    </svg>

    <script type="text/javascript">

        function debug(obj) { console.dir(obj) }

        var svg = document.getElementsByTagName('svg')[0]
        var viewport = document.getElementById('viewport')

        var circle = document.getElementById('moveMe')
            circle.addEventListener('mousedown', mouseDown)





        function SVGDragElements(svg) {
            
        }






        /**
         * Determines if an object contains the SVGTransform object in its SVGTransformList object, otherwise it creates
         * and appends a new SVGTransform object
         * 
         * @param  {object} obj svg element being clicked on
         * @return {boolean}
         */
        function containsSVGTransform(obj) {
            // SVGTransformList of the element that has been clicked on
            var tfmList = obj.transform.baseVal;

            if (tfmList.numberOfItems === 0) 
                return false

            return true
        }

        /**
         * Applies a transformation to an element
         * 
         * @param {object} el an SVG element
         * @param {object} t  transformation
         */
        function setTransform(el, t) {
            return el.transform.baseVal.initialize( t )
        }

        function mouseDown(event) {

            // store a reference to object clicked on (and presumably being dragged)
            el = event.target

            // element is selected for the first time
            if ( ! containsSVGTransform( el )) {

                // access the svg root element and create a new SVGTransform object 
                var translate = svg.createSVGTransform()

                // set default parameters
                translate.setTranslate(0,0)              

                // apply transformation
                setTransform(el, translate)
            }

            /**
             * track cursor position on the <svg> element when the <g> object is clicked on
             * 
             * note - if we had instead placed the mousemove listener on the <g> object being clicked on, 
             *        then the mouse cursor position will move faster than the <g> object's position can
             *        be updated, essentially stopping the dragging but not actually removing the listener
             */
            svg.addEventListener('mousemove', mouseMove)

            // end dragging
            event.target.addEventListener('mouseup', mouseUp) 

            // store mouse coordinates where drag event began
            var dragOrigin = {
                x : event.clientX,
                y : event.clientY
            }

            // extract current transformation matrix of viewport
            viewportCTM = viewport.getCTM()

            // extract (sx, sy, tx, ty) from the matrix
            viewportMatrix = {
                tx : viewportCTM.e,
                ty : viewportCTM.f,
                sx : viewportCTM.a,
                sy : viewportCTM.d
            }

            // get current transformation matrix of <g> element
            elementCTM = this.getCTM()

            // current (x,y) on the <g> element - equivalent to (tx,ty) in the matrix
            var activeTranslate = {
                x : elementCTM.e,
                y : elementCTM.f
            }

            // calculate the offset as the difference between the mouse click (x,y)
            // and the existing transform(x,y) on the object
            mouseOffset = {
                x : (dragOrigin.x - activeTranslate.x),
                y : (dragOrigin.y - activeTranslate.y)
            }

            // debugging
            // debug('Mouse Down Start (x,y): ' + dragOrigin.x + ' | ' + dragOrigin.y)
            // debug('DragX & DragY: ' + activeTranslate.x + ' | ' + activeTranslate.y)
            // debug('Mouse Offset: ' + mouseOffset.x + ' | ' + mouseOffset.y)
        }

        function mouseMove(event) {

            // store mouse coordinates where drag event ends
            dragEnd = {
                x: event.clientX,
                y: event.clientY
            }

            // debugging
            // debug('Mouse Down End (x,y): ' + dragEnd.x + ' | ' + dragEnd.y)

            // calculate the final coordinates of the element and adjust for viewport transformation and scale
            dragEnd.x = (dragEnd.x - mouseOffset.x - viewportMatrix.tx) * (1 / viewportMatrix.sx)
            dragEnd.y = (dragEnd.y - mouseOffset.y - viewportMatrix.ty) * (1 / viewportMatrix.sy)
            
            // debugging
            // debug('Final Position: ' + dragEnd.x + ' | ' + dragEnd.y)

            // set new translation (through SVG DOM)
            el.transform.baseVal.getItem(0).setTranslate(dragEnd.x, dragEnd.y)
        }

        function mouseUp(event) {
            // remove the mousemove listener from the svg container
            svg.removeEventListener('mousemove', mouseMove)
        }












    </script>

    <!-- Javascript -->
    <script src="js/zoomPan.js"></script>
    <script type="text/javascript">
        panZoomSVG(svg)
    </script>

</body>
</html>